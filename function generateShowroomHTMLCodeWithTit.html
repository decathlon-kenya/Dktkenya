function generateShowroomHTMLCodeWithTitle() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var outputSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Generated Code');

  outputSheet.clear();

  var data = sheet.getDataRange().getValues();

  // Assuming all values are in the second row (index 1)
  var showroomTitle = data[1][0]; // Column A
  var categoryNumber = data[1][1]; // Column B
  var objectIDs = data[1][2]; // Column C
  var productCampaignText = data[1][3]; // Column D (This will be the static text for the sticker on EACH product)

  var objectIDsArray = objectIDs ? objectIDs.split(',').map(id => `'${id.trim()}'`) : [];

  var productFunctionCall = "";
  // Determine if it's a discounted products section based on the title.
  var isDiscountSection = showroomTitle.toLowerCase().includes('discount');

  if (categoryNumber) {
    productFunctionCall = isDiscountSection
      ? `getDiscountedProductsFromCategory(10, ${categoryNumber}, [${objectIDsArray.join(', ')}])`
      : `getProductsFromCategory(10, ${categoryNumber}, [${objectIDsArray.join(', ')}])`;
  } else if (objectIDsArray.length > 0) {
    productFunctionCall = `getProductsManual([${objectIDsArray.join(', ')}])`;
  }

  // Escape single quotes in productCampaignText for Alpine.js if it contains them
  // This helps prevent syntax errors if the text includes characters that break the string literal.
  var escapedProductCampaignText = productCampaignText.replace(/'/g, "\\'");


  // --- Start generating HTML ---
  var htmlCode = `
<div class="showroom-heading">
  <h2 id="showroom-title">${showroomTitle}</h2>
</div>
<div class="component-container" style="margin-left: 10px;">
  <div class="showroom-container">
    <div class="showroom-products-wrapper">
      <div class="swiper-button-prev left_no_image_arrow showroom_arrow"></div>
      <div class="swiper-button-next right_no_image_arrow showroom_arrow"></div>
      <div class="showroom-products-container">`;

  if (productFunctionCall) {
    // Pass the productCampaignText to the Alpine.js data component
    htmlCode += `
          <section x-data="products('${escapedProductCampaignText}')" x-intersect.once.margin.300px="${productFunctionCall}">`;
  }

  htmlCode += `
            <div class="showroom-products-container no-image-track" style="display: flex;">
              <template x-for="product in products">
                <div class="product--card">
                  <a :href="product.url" style="text-decoration: none; color: black;">
                    <div class="product-picture-wrapper">
                      <span>
                        <img class="product-picture" :alt="product.product_name" :src="updateImageUrl(product.image_url)" loading="lazy" />
                      </span>
                      <!-- Product Campaign Sticker for each image -->
                      <template x-if="campaignText">
                          <div class="product-campaign-sticker" x-text="campaignText"></div>
                      </template>
                    </div>
                    <div class="product-details-wrapper">
                      <div>
                        <div class="product-brand-wrapper">
                          <span class="product-brand" x-text="product.brand"></span>
                        </div>

                        <div class="product-name" x-text="product.product_name"></div>

                        <div style="display: flex; align-items: baseline; flex-wrap: wrap; margin-top: 5px;">
                          <span class="product-price" style="padding:5px 0px; color:#101010; font-size: 14px;">
                            <span x-text="'KES ' + product.prix.toFixed(0) "></span>
                          </span>

                          <template x-if="product.regular && product.regular > product.prix">
                            <span class="old-price" style="padding:5px 0px; color:#616161; text-decoration:line-through; font-size: 14px; margin-left: 5px;">
                              <span x-text="'KES ' + product.regular.toFixed(0)"></span>
                            </span>
                          </template>

                          <template x-if="product.percentoff && product.percentoff > 0">
                            <span style="background-color: #e3262f; color:white; font-weight: bold; font-size: 14px; padding: 5px; border-radius: 3px; margin-left: 5px;">
                              -<span x-text="product.percentoff.toFixed(0)"></span>%
                            </span>
                          </template>
                        </div>
                      </div>
                    </div>
                    <div style="box-sizing: border-box; margin: auto 0px 0px; min-width: 0px;">
                      <button class="vp-button">
                        <span class="vp-button__label">
                          <div style="align-items: center; display: flex; justify-content: center;">
                            <svg style="width: 20px; height: 20px; flex: 0 0 auto;" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="24" stroke-width="1.5" aria-hidden="true">
                              <path d="M15.9999 15.7666C17.4821 15.7666 18.6865 14.5622 18.6865 13.0801C18.6865 11.598 17.4821 10.3936 15.9999 10.3936C14.5178 10.3936 13.3134 11.598 13.3134 13.0801C13.3134 14.5622 14.5178 15.7666 15.9999 15.7666Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                              <path d="M21.708 21.7079L17.8747 17.8746C18.9836 16.5674 19.6865 14.8329 19.6865 13.0801C19.6865 8.99472 16.0118 5.32007 11.9264 5.32007C7.84103 5.32007 4.16638 8.99472 4.16638 13.0801C4.16638 17.1655 7.84103 20.84 11.9264 20.84C13.6804 20.84 15.3587 20.2371 16.6977 19.1949L20.5309 23.0281C20.7301 23.2273 20.9919 23.3264 21.2537 23.3264C21.5155 23.3264 21.7774 23.2273 21.9766 23.0281C22.3749 22.6299 22.3749 21.9963 21.9771 21.5985L21.708 21.7079Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                            View Product
                          </div>
                        </span>
                      </button>
                    </div>
                  </a>
                </div>
              </template>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>`;

  // Write final HTML to the sheet
  outputSheet.getRange(1, 1).setValue(htmlCode);
}